---
title: "Assess genus-wide Lepto coverage with a SWGA primer set"
output: html_notebook
---

```{r}
require(dplyr)
require(tidyr)
require(ggplot2)
```
Load data
```{r}
run <- "swga_results_lepto_human_fg_bind_rate0.000025_min_tmp_35"
sets_file <- "sets_top_300_score.txt"
set <- "set_38"
set_score_files <- list.files(
  path = paste("results", run, "genus_coverage", set, sep = "/"),
  pattern = "set_score_",
  full.names = T
)

bg_dist_mean <- unlist(read.delim(file = paste("results", run, "swga", sets_file, sep = "/")) %>%
        filter(X_id == as.integer(gsub(x = set, pattern = "set_", replacement = ""))) %>%
        select(bg_dist_mean))

is_first <- T
for (file in set_score_files) {
  split_file_path <- strsplit(x = file, split = "/")[[1]]
  file_name <- split_file_path[length(split_file_path)]
  file_name <- gsub(x = file_name, pattern = "set_score_", replacement = "")
  file_name <- gsub(x = file_name, pattern = ".txt", replacement = "")
  set_score_data_tmp <- read.delim(file = file) %>%
          select(starts_with("fg_")) %>%
          mutate(file = file_name)
  if (is_first) {
    set_score_data <- set_score_data_tmp
    is_first <- F
  } else {
    set_score_data <- rbind(set_score_data, set_score_data_tmp)
  }
}

# Add species based on file name to species mapping prev generated in check_species.rmd
file_name_to_species <- read.delim(
        "lepto_species_assemblies/file_name_to_species.txt",
        sep = " "
) %>% separate(
        col = "file_name",
        sep = "\\/",
        into = c("file_p1", "file_p2", "file_p3")
) %>% separate(
        col = "file_p3",
        sep = ".fna.gz",
        into = c("file", "file_p4")
) %>% select(file, species)

set_score_data_w_species <- merge(
        x = set_score_data,
        y = file_name_to_species,
        all = T
)
```
Plot primer binding statistics
```{r}
# Put species in coverage order
set_score_data_w_species <- set_score_data_w_species %>%
        arrange(desc(fg_dist_mean)) %>%
        mutate(order = factor(x = 1:n(), labels = species))

ggplot(
        data = set_score_data_w_species,
        aes(x = order, y = fg_dist_mean)) +
        geom_col() +
        geom_errorbar(aes(ymin = fg_dist_mean, ymax = fg_dist_mean + fg_dist_std)) +
        # geom_hline(aes(yintercept = bg_dist_mean), linetype = "dashed", color = "red") +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
        labs(x = element_blank(), y = "Distance between binding sites")

ggsave(
        filename = paste("results", run, "genus_coverage", set, "genus_coverage.png", sep = "/"),
        width = 6.5,
        height = 4,
        units = "in"
)
```
